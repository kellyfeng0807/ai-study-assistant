name: Deploy frontend to GitHub Pages and trigger backend deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - list repo root
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la

      - name: Setup Node (for optional frontend build)
        uses: actions/setup-node@v4
        with:
          node-version: '18'


      - name: Debug - show frontend contents
        run: |
          echo "frontend top-level:"
          ls -la frontend || true
          echo "frontend/*.html:"
          ls -la frontend/*.html || true
          echo "frontend/static/js:"
          ls -la frontend/static/js || true
          echo "frontend/static/css:"
          ls -la frontend/static/css || true
          echo "frontend/build (if any):"
          ls -la frontend/build || true
          echo "frontend/dist (if any):"
          ls -la frontend/dist || true

      - name: Inject backend URL for frontend JS (create api_config.js)
        # 需要在仓库 Secrets 添加 BACKEND_URL（例如: https://your-backend.onrender.com）
        run: |
          if [ -z "${{ secrets.BACKEND_URL }}" ]; then
            echo "WARNING: BACKEND_URL secret is empty. Frontend won't have backend URL injected."
          else
            mkdir -p frontend/static/js
            cat > frontend/static/js/api_config.js <<'JS'

          window.BACKEND_URL = "${{ secrets.BACKEND_URL }}";
          JS
            echo "Created frontend/static/js/api_config.js"
          fi

      

      - name: Determine publish directory (frontend or frontend/build)
        id: determine
        run: |
          PUBLISH=""
          if [ -d frontend/build ] && [ "$(ls -A frontend/build 2>/dev/null)" ]; then
            PUBLISH="frontend/build"
          elif [ -d frontend/dist ] && [ "$(ls -A frontend/dist 2>/dev/null)" ]; then
            PUBLISH="frontend/dist"
          else
            # default to frontend (no copy)
            PUBLISH="frontend"
          fi
          echo "PUBLISH_PATH=$PUBLISH" >> $GITHUB_ENV
          echo "Will publish: $PUBLISH"

      - name: Show publish path
        run: |
          echo "PUBLISH_PATH=${{ env.PUBLISH_PATH }}"
          ls -la "${{ env.PUBLISH_PATH }}" || true

      - name: Setup Pages (create site if needed)
        uses: actions/configure-pages@v4
        with:
          enablement: 'github-actions'

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.PUBLISH_PATH }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # 可选：保留触发 Render 的步骤（如果你仍想在前端部署后触发后端）
  trigger-backend:
    name: Trigger backend deploy (Render) (optional)
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render deploy via webhook (if secret exists)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "No RENDER_DEPLOY_HOOK secret set, skipping backend deploy."
            exit 0
          fi
          echo "Triggering Render deploy..."
          curl -sS -X POST "$RENDER_DEPLOY_HOOK" -o /tmp/render_resp.txt || true
          echo "Render response:"
          cat /tmp/render_resp.txt || true
