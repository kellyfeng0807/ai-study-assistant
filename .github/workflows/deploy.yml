name: Deploy frontend to GitHub Pages and trigger backend deploy (via gh-pages branch)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (for optional frontend build)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Optional Build frontend
        run: |
          if [ -f frontend/package.json ]; then
            cd frontend
            npm ci
            npm run build || npm run build --if-present || true
            cd ..
          else
            echo "No frontend/package.json â€” skipping build"
          fi

      - name: Determine publish dir
        id: determine
        run: |
          if [ -d frontend/build ] && [ "$(ls -A frontend/build 2>/dev/null)" ]; then
            echo "publish=frontend/build" >> $GITHUB_OUTPUT
          elif [ -d frontend/dist ] && [ "$(ls -A frontend/dist 2>/dev/null)" ]; then
            echo "publish=frontend/dist" >> $GITHUB_OUTPUT
          else
            echo "publish=frontend" >> $GITHUB_OUTPUT
          fi

      - name: Show publish dir
        run: |
          echo "Publish dir: ${{ steps.determine.outputs.publish }}"
          ls -la "${{ steps.determine.outputs.publish }}" || true

      - name: Inject backend URL (inline)
        run: |
          PUBLISH_DIR="${{ steps.determine.outputs.publish }}"
          mkdir -p "$PUBLISH_DIR/static/js"
          printf 'window.BACKEND_URL = "%s";\n' "https://ai-study-assistant-2ozw.onrender.com" > "$PUBLISH_DIR/static/js/api_config.js"
          echo "Wrote api_config.js with hardcoded BACKEND_URL"

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ steps.determine.outputs.publish }}
          publish_branch: gh-pages
          # optional: set user info for commit
          user_name: github-actions
          user_email: github-actions@github.com

  trigger-backend:
    name: Trigger backend deploy (Render) (optional)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render deploy via webhook
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "No RENDER_DEPLOY_HOOK secret set, skipping backend deploy."
            exit 0
          fi
          curl -sS -X POST "$RENDER_DEPLOY_HOOK" -o /tmp/render_resp.txt || true
          echo "Render response:"
          cat /tmp/render_resp.txt || true
